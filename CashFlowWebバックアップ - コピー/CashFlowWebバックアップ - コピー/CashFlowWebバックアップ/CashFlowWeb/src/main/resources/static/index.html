<!DOCTYPE html>
<html class="dark" lang="ja">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>FutureFlow ダッシュボード</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .material-symbols-outlined { font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24; }
        .modal { backdrop-filter: blur(5px); }
    </style>
    <script>
        tailwind.config = { darkMode: "class", theme: { extend: { colors: { "primary": "#258cf4", "background-dark": "#101922" }, fontFamily: { "display": ["Inter", "sans-serif"] }, } } }
        Chart.defaults.color = '#9ca3af';
        Chart.defaults.borderColor = '#374151';
    </script>
</head>

<body class="bg-background-dark text-[#E0E0E0]">
<div class="flex min-h-screen">
    
    <aside class="flex w-64 flex-col border-r border-white/10 bg-[#111418] p-4">
        <div class="flex flex-col gap-4">
            <div class="flex items-center gap-3 p-2">
                <span class="material-symbols-outlined text-primary" style="font-size:32px;">monitoring</span>
                <div class="flex flex-col"><h1 class="text-base font-medium leading-normal text-white">FutureFlow</h1><p class="text-sm font-normal leading-normal text-[#9cabba]">ようこそ</p></div>
            </div>
            <nav class="mt-4 flex flex-col gap-2">
                <a class="flex items-center gap-3 rounded-lg bg-primary/20 px-3 py-2 text-primary" href="/index.html">
                    <span class="material-symbols-outlined" style="font-variation-settings: 'FILL' 1;">dashboard</span><p class="text-sm font-medium leading-normal">ダッシュボード</p>
                </a>
                <a class="flex items-center gap-3 rounded-lg px-3 py-2 text-white transition-colors hover:bg-white/10" href="/goals.html">
                    <span class="material-symbols-outlined">flag</span><p class="text-sm font-medium leading-normal">目標管理</p>
                </a>
                <a class="flex items-center gap-3 rounded-lg px-3 py-2 text-white transition-colors hover:bg-white/10" href="/portfolio.html">
                    <span class="material-symbols-outlined">trending_up</span><p class="text-sm font-medium leading-normal">ポートフォリオ</p>
                </a>
                <a class="flex items-center gap-3 rounded-lg px-3 py-2 text-white transition-colors hover:bg-white/10" href="/budgets.html">
                    <span class="material-symbols-outlined">savings</span><p class="text-sm font-medium leading-normal">予算管理</p>
                </a>
                <a class="flex items-center gap-3 rounded-lg px-3 py-2 text-white transition-colors hover:bg-white/10" href="/categories.html">
                    <span class="material-symbols-outlined">label</span><p class="text-sm font-medium leading-normal">カテゴリ管理</p>
                </a>
                
            </nav>
        </div>
        <form action="/logout" method="POST" class="mt-auto pt-4 border-t border-white/10">
            <button type="submit" class="flex w-full items-center gap-3 rounded-lg px-3 py-2 text-gray-400 transition-colors hover:bg-red-500/20 hover:text-red-400">
                <span class="material-symbols-outlined">logout</span>
                <p class="text-sm font-medium leading-normal">ログアウト</p>
            </button>
       </form>
    </aside>
    <main class="flex-1 overflow-y-auto p-8">
        <div class="mx-auto max-w-7xl">
            <header class="mb-6 flex justify-between items-center">
                <p class="text-4xl font-black leading-tight tracking-[-0.033em] text-white">ダッシュボード</p>
                <button onclick="openModal()" class="flex h-10 cursor-pointer items-center justify-center gap-2 overflow-hidden rounded-lg bg-primary px-4 text-sm font-bold text-white transition-opacity hover:opacity-90"><span class="material-symbols-outlined">add</span><span>取引を追加</span></button>
            </header>

            <div class="mb-8 grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                <div class="flex flex-col gap-2 rounded-xl border border-[#314668] bg-[#1a2333] p-6"><p class="text-base font-medium text-gray-400">今月の総支出</p><p id="total-spending" class="text-3xl font-bold tracking-tight text-white">¥0</p></div>
                <div class="flex flex-col gap-2 rounded-xl border border-[#314668] bg-[#1a2333] p-6"><p class="text-base font-medium text-gray-400">今月の純利益</p><p id="net-income" class="text-3xl font-bold tracking-tight text-white">¥0</p></div>
                <div class="flex flex-col gap-2 rounded-xl border border-[#314668] bg-[#1a2333] p-6"><p class="text-base font-medium text-gray-400">現在の総資産</p><p id="total-balance" class="text-3xl font-bold tracking-tight text-white">¥0</p></div>
            </div>

            <div class="mb-8">
                <h3 class="mb-4 text-lg font-semibold text-white">進行中の目標</h3>
                <div id="goals-container" class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3">
                    </div>
            </div>
            <div class="mb-8 grid grid-cols-1 gap-8 lg:grid-cols-2">
                <div class="flex flex-col gap-4 rounded-xl border border-[#314668] bg-[#1a2333] p-6"><p class="text-lg font-semibold text-white">支出の内訳</p><div class="relative flex min-h-[250px] items-center justify-center"><canvas id="expense-pie-chart"></canvas></div><div id="pie-chart-legend" class="grid grid-cols-2 gap-x-6 gap-y-3"></div></div>
                <div class="flex flex-col gap-4 rounded-xl border border-[#314668] bg-[#1a2333] p-6"><p class="text-lg font-semibold text-white">月ごとの推移</p><div class="relative min-h-[300px]"><canvas id="monthly-bar-chart"></canvas></div></div>
            </div>

            <div class="overflow-hidden rounded-xl border border-[#314668] bg-[#1a2333]">
                <div class="flex items-center justify-between gap-4 p-6"><h3 class="text-lg font-semibold text-white">最近の取引履歴</h3></div>
                <div class="overflow-x-auto"><table class="w-full text-left"><thead class="border-b border-t border-[#314668]"><tr><th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-gray-400">日付</th><th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-gray-400">カテゴリ</th><th class="px-6 py-3 text-xs font-medium uppercase tracking-wider text-gray-400">種類</th><th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider text-gray-400">金額</th></tr></thead><tbody id="transaction-table-body" class="divide-y divide-[#223149]"></tbody></table></div>
            </div>
            <form action="/logout" method="POST" class="mt-auto pt-4 border-t border-white/10">
                <button type="submit" class="flex w-full items-center gap-3 rounded-lg px-3 py-2 text-gray-400 transition-colors hover:bg-red-500/20 hover:text-red-400">
                    <span class="material-symbols-outlined">logout</span>
                    <p class="text-sm font-medium leading-normal">ログアウト</p>
                </button>
           </form>

        </div>
    </main>
</div>
<div id="transaction-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 p-4" style="backdrop-filter: blur(5px);">
    <div class="w-full max-w-md rounded-xl border border-gray-700 bg-[#111418] p-6">
        <div class="flex items-center justify-between"><h2 id="modal-title" class="flex items-center gap-3 text-lg font-bold text-white"></h2><button onclick="closeModal()" class="text-gray-400 hover:text-white"><span class="material-symbols-outlined">close</span></button></div>
        <form id="transaction-form" class="mt-4 grid grid-cols-1 gap-4">
            <input type="hidden" id="transaction-id">
            <div><label class="mb-2 block text-sm font-medium text-gray-400" for="date">日付</label><input class="block w-full rounded-lg border-transparent bg-[#283039] text-white focus:border-primary focus:ring-primary sm:text-sm" id="date" type="date" required style="color-scheme: dark;"></div>
            <div><label class="mb-2 block text-sm font-medium text-gray-400" for="type">種類</label><select class="block w-full rounded-lg border-transparent bg-[#283039] text-white focus:border-primary focus:ring-primary sm:text-sm" id="type" required><option value="EXPENSE">支出</option><option value="INCOME">収入</option></select></div>
            <div><label class="mb-2 block text-sm font-medium text-gray-400" for="category">カテゴリ</label><select class="block w-full rounded-lg border-transparent bg-[#283039] text-white focus:border-primary focus:ring-primary sm:text-sm" id="category" required></select></div>
            <div><label class="mb-2 block text-sm font-medium text-gray-400" for="amount">金額</label><input class="block w-full rounded-lg border-transparent bg-[#283039] text-white focus:border-primary focus:ring-primary sm:text-sm" id="amount" type="number" required></div>
            <button class="mt-4 flex w-full items-center justify-center gap-2 rounded-lg bg-primary py-3 font-semibold text-white hover:bg-primary/90" type="submit"><span class="material-symbols-outlined">save</span>保存</button>
        </form>
    </div>
</div>
<div id="goal-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/70 p-4" style="backdrop-filter: blur(5px);">
    <div class="w-full max-w-md rounded-xl border border-gray-700 bg-[#111418] p-6">
        <div class="flex items-center justify-between">
            <h2 class="flex items-center gap-3 text-lg font-bold text-white"><span class="material-symbols-outlined">savings</span>貯金を追加</h2>
            <button onclick="closeGoalModal()" class="text-gray-400 hover:text-white"><span class="material-symbols-outlined">close</span></button>
        </div>
        <div class="mt-4">
            <p class="mb-4 text-sm text-gray-400">目標: <span id="modal-goal-name" class="font-bold text-white"></span></p>
            <div>
                <label class="mb-2 block text-sm font-medium text-gray-400" for="modal-amount-input">追加する金額</label>
                <input class="block w-full rounded-lg border-transparent bg-[#283039] text-white focus:border-primary focus:ring-primary sm:text-sm" id="modal-amount-input" type="number" placeholder="例: 5000" required>
            </div>
            <button onclick="handleAddSavings()" class="mt-6 flex w-full items-center justify-center gap-2 rounded-lg bg-primary py-3 font-semibold text-white hover:bg-primary/90" type="button">
                <span class="material-symbols-outlined">save</span>保存
            </button>
        </div>
    </div>
</div>
<script>
    let pieChart = null, barChart = null;
    const modal = document.getElementById('transaction-modal');
    const form = document.getElementById('transaction-form');
    
    // ▼▼▼ 【変更点】グローバル変数を追加 ▼▼▼
    let selectedGoal = null; 
    let goalCategoryId = null; 
    // ▲▲▲ 【変更点】ここまで ▲▲▲

    document.addEventListener('DOMContentLoaded', () => {
        populateCategories(); // ★変更点: updateDashboardより先に実行
        updateDashboard();
        form.addEventListener('submit', handleFormSubmit);
    });

    function openModal() {
        form.reset();
        document.getElementById('modal-title').innerHTML = `<span class="material-symbols-outlined">add_circle</span> 新しい取引を追加`;
        document.getElementById('transaction-id').value = '';
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
        modal.classList.remove('hidden'); modal.classList.add('flex');
    }

    function closeModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); }

    async function handleFormSubmit(event) {
        event.preventDefault();
        
        // ▼▼▼ 【変更点】手動での「貯金」カテゴリへの追加を防止 ▼▼▼
        const selectedCatId = parseInt(document.getElementById('category').value);
        if (selectedCatId === goalCategoryId) {
            alert("「貯金」カテゴリへの取引は、ダッシュボードの目標カードから直接追加してください。");
            return;
        }
        // ▲▲▲ 【変更点】ここまで ▲▲▲
        
        const data = { 
            date: document.getElementById('date').value, 
            type: document.getElementById('type').value, 
            categoryId: selectedCatId, // 上で取得した変数を使用
            amount: parseFloat(document.getElementById('amount').value), 
            isFuture: false, 
            isExtraordinary: false 
        };
        await fetch('/api/transactions', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) });
        closeModal();
        updateDashboard();
    }
    
    async function updateDashboard() {
        // APIエンドポイントが /api/transactions/summary のまま
        const [balanceRes, summaryRes] = await Promise.all([
            fetch('/api/transactions/balance'),
            fetch('/api/transactions/summary') 
        ]);
        
        const balance = await balanceRes.json();
        document.getElementById('total-balance').textContent = `¥${Math.round(balance).toLocaleString()}`;
        
        const monthlyData = await summaryRes.json();
        if (monthlyData.length > 0) {
            const latestMonth = monthlyData[0];
            const netIncome = latestMonth.totalIncome - latestMonth.totalExpense;
            document.getElementById('total-spending').textContent = `¥${Math.round(latestMonth.totalExpense).toLocaleString()}`;
            document.getElementById('net-income').textContent = `¥${Math.round(netIncome).toLocaleString()}`;
        }
        
        fetchTransactions();
        updatePieChart();
        renderBarChart(monthlyData);
        displayGoals(); // 呼び出しは元のコードに存在
    }
    
    async function fetchTransactions() {
        const response = await fetch('/api/transactions');
        const transactions = await response.json();
        const tableBody = document.getElementById('transaction-table-body');
        tableBody.innerHTML = '';
        transactions.slice(0, 5).forEach(tx => {
            // (元のコードのまま)
            const row = document.createElement('tr');
            const amountClass = tx.type === 'INCOME' ? 'text-green-400' : 'text-red-400';
            const amountSign = tx.type === 'INCOME' ? '+' : '-';
            row.innerHTML = `<td class="px-6 py-4 text-sm text-gray-300">${tx.date}</td><td class="px-6 py-4 text-sm font-medium text-white">${tx.categoryName}</td><td><span class="rounded-full bg-gray-700/50 px-2 py-1 text-xs font-medium text-gray-300">${tx.type === 'EXPENSE' ? '支出' : '収入'}</span></td><td class="px-6 py-4 text-right text-sm font-medium ${amountClass}">${amountSign}¥${tx.amount.toLocaleString()}</td>`;
            tableBody.appendChild(row);
        });
    }

    async function updatePieChart() {
        // (元のコードのまま)
        const today = new Date();
        const startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
        const endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
        
        const response = await fetch(`/api/transactions/summary/category?startDate=${startDate}&endDate=${endDate}&type=EXPENSE`);
        const data = await response.json();
        renderPieChart(data);
    }

    function renderPieChart(data) {
        // (元のコードのまま)
        const ctx = document.getElementById('expense-pie-chart').getContext('2d');
        if (pieChart) pieChart.destroy();
        const chartColors = ['#4a90e2', '#9013fe', '#3c83f6', '#0bda5e', '#f5a623'];
        pieChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.map(d => d.categoryName),
                datasets: [{ data: data.map(d => d.totalAmount), backgroundColor: chartColors, borderColor: '#16212e', borderWidth: 4 }]
            },
            options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { display: false } } }
        });
        
        const legendContainer = document.getElementById('pie-chart-legend');
        legendContainer.innerHTML = '';
        let totalSpent = 0;
        data.forEach((item, index) => {
            totalSpent += item.totalAmount;
            legendContainer.innerHTML += `<div class="flex items-center gap-3"><div class="size-3 rounded-full" style="background-color: ${chartColors[index % chartColors.length]}"></div><span class="text-sm text-gray-300">${item.categoryName}</span><span class="ml-auto text-sm font-medium text-white">¥${Math.round(item.totalAmount).toLocaleString()}</span></div>`;
        });
    }

    function renderBarChart(monthlyData) {
        // (元のコードのまま)
        const data = monthlyData.slice(0, 6).reverse();
        const labels = data.map(d => d.month.substring(5) + '月');
        const incomeData = data.map(d => d.totalIncome);
        const expenseData = data.map(d => d.totalExpense);
        const ctx = document.getElementById('monthly-bar-chart').getContext('2d');
        if (barChart) barChart.destroy();
        barChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    { label: '収入', data: incomeData, backgroundColor: 'rgba(37, 140, 244, 0.5)', borderColor: '#258cf4', borderWidth: 1, borderRadius: 4 },
                    { label: '支出', data: expenseData, backgroundColor: 'rgba(59, 71, 82, 0.5)', borderColor: '#3b4754', borderWidth: 1, borderRadius: 4 }
                ]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#374151' } }, x: { grid: { display: false } } }, plugins: { legend: { align: 'end', labels: { usePointStyle: true, boxWidth: 8 } } } }
        });
    }

    async function populateCategories() {
        const response = await fetch('/api/categories');
        const categories = await response.json();
        const select = document.getElementById('category');
        select.innerHTML = '';
        
        categories.forEach(cat => {
            const option = document.createElement('option');
            option.value = cat.id;
            option.textContent = `${cat.name} (${cat.type === 'INCOME' ? '収入' : '支出'})`;
            
            // ▼▼▼ 【変更点】「貯金」カテゴリのIDを変数に保存し、ドロップダウンからは除外 ▼▼▼
            if (cat.name === "貯金" && cat.type === "EXPENSE") {
                goalCategoryId = cat.id; // IDはグローバル変数に保存
            } else {
                select.appendChild(option); // それ以外のカテゴリをドロップダウンに追加
            }
            // ▲▲▲ 【変更点】ここまで ▲▲▲
        });
        
        if (!goalCategoryId) {
            console.error("【重要】「貯金」カテゴリ(支出)が見つかりませんでした。");
            // ステップ1＆2が実行されていれば、このエラーは出ません。
        }
    }

    // ▼▼▼ 【変更点】「displayGoals」関数の中身を実装 ▼▼▼
    async function displayGoals() {
        try {
            const response = await fetch('/api/goals');
            if (!response.ok) {
                console.error("目標データの取得に失敗しました。");
                return;
            }
            const goals = await response.json();
            const container = document.getElementById('goals-container');
            container.innerHTML = ''; // コンテナを初期化

            if (goals.length === 0) {
                container.innerHTML = `<p class="col-span-full text-gray-400">現在、設定されている目標はありません。「目標管理」ページから新しい目標を追加しましょう。</p>`;
                return;
            }

            goals.forEach(goal => {
                const progress = goal.targetAmount > 0 ? (goal.currentAmount / goal.targetAmount) * 100 : 0;
                
                const goalCard = document.createElement('div');
                // 元のスタイル(flex, gap, rounded-xl, etc.)を維持し、relativeを追加
                goalCard.className = "flex flex-col gap-3 rounded-xl border border-[#314668] bg-[#1a2333] p-5 relative"; 

                goalCard.innerHTML = `
                    <div class="absolute inset-0 z-10 cursor-pointer rounded-xl transition-colors hover:border-primary border-2 border-transparent" 
                         onclick='openGoalModal(${JSON.stringify(goal)})'>
                    </div>
                    
                    <button 
                        onclick="handleDeleteGoal(event, ${goal.id})" 
                        class="absolute top-3 right-3 z-20 p-1 rounded-full text-gray-500 hover:text-red-400 hover:bg-gray-700 transition-colors">
                        <span class="material-symbols-outlined" style="font-size: 20px;">delete</span>
                    </button>

                    <div class="relative z-0">
                        <div class="flex items-center justify-between pr-8"> <p class="font-semibold text-white">${goal.name}</p>
                            <span class="text-sm font-medium text-primary">${Math.round(progress)}%</span>
                        </div>
                        <div class="h-2.5 w-full rounded-full bg-gray-700 mt-3">
                            <div class="bg-primary h-2.5 rounded-full" style="width: ${Math.min(progress, 100)}%"></div>
                        </div>
                        <div class="text-sm text-gray-400 mt-3">
                            <span>¥${goal.currentAmount.toLocaleString()}</span> / <span>¥${goal.targetAmount.toLocaleString()}</span>
                        </div>
                    </div>
                `;
                container.appendChild(goalCard);
            });
        } catch (error) {
            console.error("目標の表示中にエラーが発生しました:", error);
            const container = document.getElementById('goals-container');
            container.innerHTML = `<p class="col-span-full text-red-400">目標の読み込みに失敗しました。</p>`;
        }
    }
    // ▲▲▲ 【変更点】ここまで ▲▲▲


    // ▼▼▼ 【ここから新規追加】目標更新モーダルのための関数群 ▼▼▼

    /**
     * 目標モーダルを開く
     */
    function openGoalModal(goal) {
        selectedGoal = goal; // 編集対象の目標をグローバル変数に保存
        document.getElementById('modal-goal-name').textContent = goal.name;
        document.getElementById('goal-modal').classList.remove('hidden');
        document.getElementById('goal-modal').classList.add('flex'); // flexを追加
    }

    /**
     * 目標モーダルを閉じる
     */
    function closeGoalModal() {
        document.getElementById('goal-modal').classList.add('hidden');
        document.getElementById('goal-modal').classList.remove('flex'); // flexを削除
        document.getElementById('modal-amount-input').value = ''; // 入力をクリア
        selectedGoal = null; // 選択を解除
    }

    /**
     * 【機能追加】目標の削除
     */
    async function handleDeleteGoal(event, goalId) {
        // バブリングを停止し、親DIVのクリックイベント(openGoalModal)を防ぐ
        event.stopPropagation(); 
        
        if (!confirm("この目標を削除しますか？\n（この操作は取り消せません）")) {
            return;
        }

        try {
            const response = await fetch(`/api/goals/${goalId}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                // 削除成功
                updateDashboard(); // ダッシュボードをリロード
            } else {
                alert('目標の削除に失敗しました。');
            }
        } catch (error) {
            console.error("目標削除時のエラー:", error);
            alert('通信エラーが発生しました。');
        }
    }

    /**
     * 【機能追加】貯金の追加（残高連携）
     */
    async function handleAddSavings() {
        if (!selectedGoal) return;
        
        if (!goalCategoryId) {
            alert('「貯金」カテゴリが見つかりません。アプリケーションをリロードするか、管理者に連絡してください。\n（ステップ1, 2を完了しましたか？）');
            return;
        }

        const amountInput = document.getElementById('modal-amount-input');
        const amountToAdd = parseFloat(amountInput.value);

        if (isNaN(amountToAdd) || amountToAdd <= 0) {
            alert('有効な金額を入力してください。');
            return;
        }

        // ステップ1：支出取引を作成（総残高から引く）
        const transactionData = {
            date: new Date().toISOString().split('T')[0], // 今日の日付
            amount: amountToAdd,
            categoryId: goalCategoryId,
            type: "EXPENSE",
            isFuture: false,
            isExtraordinary: true // 目標への貯金は臨時支出とする
        };
        
        try {
            const txResponse = await fetch('/api/transactions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(transactionData)
            });

            if (!txResponse.ok) {
                throw new Error('支出の作成に失敗しました。');
            }
            
            // ステップ2：支出作成が成功したら、目標の現在額を更新
            const updatedGoal = {
                ...selectedGoal, 
                currentAmount: selectedGoal.currentAmount + amountToAdd 
            };
            
            if (updatedGoal.currentAmount > updatedGoal.targetAmount) {
                updatedGoal.currentAmount = updatedGoal.targetAmount;
            }

            const goalResponse = await fetch(`/api/goals/${updatedGoal.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(updatedGoal)
            });

            if (!goalResponse.ok) {
                throw new Error('目標の更新に失敗しました。');
            }

            // ステップ3：両方成功したら、モーダルを閉じてリロード
            closeGoalModal();
            updateDashboard(); // ダッシュボード全体をリロード

        } catch (error) {
            console.error("貯金追加処理のエラー:", error);
            alert(`エラーが発生しました: ${error.message}`);
        }
    }
    // ▲▲▲ 【ここまで新規追加】▲▲▲

</script>
</body>
</html>